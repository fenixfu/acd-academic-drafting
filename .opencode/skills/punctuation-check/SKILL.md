---
name: punctuation-checker
description: 中英文混排标点检测与修正工具。当用户需要检查、校对、修正中英文混排文章中的标点符号时使用此 skill——包括检测中文句子是否误用了英文标点、英文句子是否误用了中文标点、括号全半角是否正确、引号配对与语言一致性、参考文献标点规范等。用户说"检查标点"、"校对标点"、"标点有没有问题"、"中英文标点"、"修正标点"等都应触发此 skill。
content: |
  - 中英文混排标点检测与修正
    - 用途
    - 脚本位置
    - 参数说明
    - 检测规则
      - 正文检测
      - 参考文献检测
    - Agent 的执行流程
      - 第一步：配置询问
      - 第二步：第一轮执行——仅报告
      - 第三步：警告处理
        - 类型一：参考文献语种不一致
        - 类型二：引号未配对
      - 第四步：第二轮执行——完整修正
    - 注意事项
---

# 中英文混排标点检测与修正

## 用途

检测并修正中英文混排文章中不规范的标点使用，包括：

- 中文语境误用英文半角标点（如 `,` 应为 `，`）
- 英文语境误用中文全角标点（如 `，` 应为 `,`）
- 括号全半角归属（依据括号内内容语言判断）
- 引号配对与语言一致性（段落级 stack_b/meta_stack 配对算法）
- 参考文献区块的独立检测逻辑（含作者名与著作名语种不一致报警）

---

## 脚本位置

```
scripts/check_punctuation.py
```

---

## 参数说明

| 参数 | 说明 | 可选值 |
|---|---|---|
| `input` | 输入文件路径（位置参数） | 文件路径；不指定则从 stdin 读取 |
| `--refs` | 参考文献标题关键词 | `参考文献` / `References` / 自定义字符串 |
| `--quote` | 引号策略 | `A`（中文行文统一用中文引号，括号内引文除外）/ `B`（跟随引号内容语言）|
| `--mode` | 输出模式 | `report`（仅生成报告）/ `fixed`（仅输出修正文本）/ `both`（两者） |
| `-o` / `--output` | 修正文本的输出路径 | 文件路径 |
| `--report-output` | 将检测报告以 Markdown 格式写入文件 | `.md` 文件路径 |
| `--non-interactive` | 跳过交互式配置（需同时提供 `--refs`、`--quote`、`--mode`） | 无参数 flag |

---

## 检测规则

### 正文检测

**语言判断**：以行为单位，统计中文字符与英文字符的比例，多数语言决定该行期望的标点类型。

**常规标点对照**：

| 中文（全角） | 英文（半角） | 判断依据 |
|---|---|---|
| `，` | `,` | 行内中英文比例 |
| `。` | `.` | 句末字符语言 |
| `：` | `:` | 行内中英文比例 |
| `；` | `;` | 行内中英文比例 |
| `？` | `?` | 行内中英文比例 |
| `！` | `!` | 行内中英文比例 |

**句点特殊处理**：
- 前方为数字 → 排除数字列表编号（如 `1.`）与小数点误判，不替换（例外：这会使得以数字收尾、没有空格、且紧跟着标点的极为罕见的手误漏报）
- 前面是英文字母且后面不是空格+大写 → 英文缩写，不替换
- 其余中文语境句末 `.` → 替换为 `。`

**括号规则**：
- 括号内内容以英文字母开头、以英文字母或 `.` 结尾 → 半角 `()`
- 纯年份数字（如 `1999`）→ 全半角取决于所在行主导语言
- 其余 → 全角 `（）`

**引号规则**：
- 以段落（换行符）为边界，逐段收集所有引号后统一配对
- 配对使用 stack_b / meta_stack 结构：每个中文开引号 `"` 建立一层 stack_b，其内可嵌套至多一对英文引号；中文引号嵌套时通过 meta_stack 管理层级；段落开头首引号为英文时用 `^` 占位
- 段落结束后仍未闭合的引号报警；任何单双不匹配、中英混用不匹配均立即报警并精确定位
- 策略 A：中文行文统一用中文引号 `""`；括号内引文用英文引号 `""`
- 策略 B：引号内容语言决定引号形式

### 参考文献检测

**作者语种判断**：条目首字为汉字 → 中文作者；首字为拉丁字母 → 英文作者。

**语种不一致**：作者名语种 ≠ 著作名语种 → ⚠️ 警告，跳过该条自动修正。

---

## Agent 的执行流程

### 第一步：配置询问

向用户询问（可用 `ask_user` tool）：
- 参考文献标题关键词（`参考文献` / `References` / 手动输入）
- 引号策略（A / B）

### 第二步：第一轮执行——仅报告

```bash
python scripts/check_punctuation.py 输入文件.txt \
  --refs <keyword> --quote <A|B> \
  --mode report --report-output report.md \
  --non-interactive
```

**只生成报告，不修改任何文件。** 读取 `report.md`，将警告与非警告问题分开：
- 非警告问题：记录在案，留待第二轮自动修正，此时不展示给用户
- 警告：进入下方的警告处理流程

### 第三步：警告处理

若无警告，跳过此步，直接进入第四步。

若有警告，逐条按以下流程处理。**优先对每条警告单独调用** `ask_user` **tool 提问**；若 `ask_user` tool 不可用，则集中列出所有警告及建议，请用户以编号一次性回复所有选择，再统一执行。

---

#### 类型一：参考文献语种不一致

1. 从条目中提取作者名、书名/篇名、年份、出版社
2. **调用搜索工具**，核实：原著语言、是否存在中译本或英译本、GB/T 7714 标准引用格式
3. 生成一条完整的修改后条目作为建议，说明理由；若两种格式同样合理则并列给出
4. 向用户确认后，直接在原文中修改该条目

**示例建议**：
> 经查证，此为福柯《规训与惩罚》中译本，刘北成、杨远婴译，三联书店1999年版。建议统一为中文格式：
> `福柯，米歇尔（1999）.《规训与惩罚》（刘北成、杨远婴译）. 北京：三联书店.`
> 或保留英文格式：`Foucault, M. (1999). Discipline and Punish (Liu & Yang, Trans.). Beijing: Sanlian Press.`

---

#### 类型二：引号未配对

**所有情形统一先做**：提取警告所在段落作为分析窗口。

---

**情形 2a：未闭合的开引号**

在段落窗口中分析：

- 内容语义完整（有主谓、有结论）→ 建议在句末补闭引号，展示修改后效果
- 内容语义不完整，像引文中途截断 → 建议检查下一段开头是否有对应闭引号
- 附近有另一个孤立引号字符 → 建议将其中一个改为闭引号，展示两种改法

---

**情形 2b：多余的闭引号**（非误报）

始终提供**方案 A / 方案 B** 两个选项，不做单一强制推荐：

- 闭引号前紧跟完整词组（数字以内）→ 倾向方案 A（补开引号），同时提供方案 B（删除）
- 闭引号前内容较长，句子结构不需要引号 → 倾向方案 B（删除），同时提供方案 A（补开引号）

---

**类型二完整决策树**：

```
提取警告所在段落
        ↓
判断警告类型
    ├── 2a 未闭合开引号
    │     ├── 语义完整 → 建议句末补闭引号
    │     ├── 语义不完整 → 建议检查相邻段落
    │     └── 附近有孤立引号 → 建议改其中一个为闭引号
    └── 2b 多余闭引号
          ├── 前紧跟完整词组 → 方案A补开引号 / 方案B删除
          └── 前内容较长 → 方案A删除 / 方案B补开引号
```

### 第四步：第二轮执行——完整修正

所有警告处理并经用户确认修改完毕后，在已处理警告的文本上执行完整修正：

```bash
python scripts/check_punctuation.py 输入文件.txt \
  --refs <keyword> --quote <A|B> \
  --mode both \
  --output 输出文件_fixed.txt \
  --report-output report_final.md \
  --non-interactive
```

此时原文引号配对已正确，自动修正结果可信。若第二轮报告仍有警告（极少数），重复第三步流程。

向用户提供修正后文件及最终报告。


## 注意事项

- 英文书名/专有名词内部标点出现在中文行文中时，**不干预**，保持原有英文标点
- 脚本不修改原始文件，修正结果写入新文件
- 第一轮必须使用 `--mode report`，**不执行修正**，确保警告处理期间原文不被动过
- Windows 下已内置 UTF-8 输出修复，终端显示中文标点和 emoji 不会崩溃